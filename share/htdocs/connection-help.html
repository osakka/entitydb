<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB Connection Help</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .help-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            padding: 48px;
            max-width: 600px;
            width: 100%;
        }
        h1 {
            color: #e74c3c;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h2 {
            color: #3498db;
            margin-top: 32px;
            margin-bottom: 16px;
        }
        .status-check {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
        }
        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            font-size: 14px;
        }
        .check-item .icon {
            font-size: 20px;
        }
        .check-item.success .icon { color: #27ae60; }
        .check-item.error .icon { color: #e74c3c; }
        .check-item.loading .icon { color: #f39c12; }
        .solution {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        .solution h3 {
            margin: 0 0 8px 0;
            color: #27ae60;
        }
        .solution ol {
            margin: 8px 0;
            padding-left: 24px;
        }
        .solution li {
            margin: 8px 0;
        }
        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 16px;
        }
        .button:hover {
            background: #2980b9;
        }
        code {
            background: #f5f6fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .url-box {
            background: #f5f6fa;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-family: monospace;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="help-container">
        <h1>
            <span style="font-size: 32px;">‚ö†Ô∏è</span>
            EntityDB Connection Issue
        </h1>

        <p>We're having trouble connecting to the EntityDB server. Let's diagnose the issue:</p>

        <div class="status-check">
            <h3>Connection Status</h3>
            <div id="check-current-page" class="check-item loading">
                <span class="icon">‚è≥</span>
                <span>Checking current page...</span>
            </div>
            <div id="check-server-health" class="check-item loading">
                <span class="icon">‚è≥</span>
                <span>Checking server health...</span>
            </div>
            <div id="check-api-access" class="check-item loading">
                <span class="icon">‚è≥</span>
                <span>Checking API access...</span>
            </div>
            <div id="check-ssl-cert" class="check-item loading">
                <span class="icon">‚è≥</span>
                <span>Checking SSL certificate...</span>
            </div>
        </div>

        <div id="solutions" style="display: none;">
            <h2>Solutions</h2>
            
            <div id="ssl-solution" class="solution" style="display: none;">
                <h3>üîí SSL Certificate Not Trusted</h3>
                <p>Your browser doesn't trust the EntityDB SSL certificate. This is normal for self-signed certificates.</p>
                <ol>
                    <li>Click this link: <a href="https://localhost:8085/" target="_blank">https://localhost:8085/</a></li>
                    <li>You'll see a security warning - this is expected</li>
                    <li>Click "Advanced" or "Show Details"</li>
                    <li>Click "Proceed to localhost (unsafe)" or "Accept the Risk and Continue"</li>
                    <li>Once accepted, <a href="/index.html">return to the dashboard</a></li>
                </ol>
            </div>

            <div id="server-down-solution" class="solution" style="display: none;">
                <h3>üî¥ Server Not Running</h3>
                <p>The EntityDB server doesn't appear to be running.</p>
                <ol>
                    <li>Open a terminal</li>
                    <li>Navigate to EntityDB: <code>cd /opt/entitydb</code></li>
                    <li>Start the server: <code>./bin/entitydbd.sh start</code></li>
                    <li>Wait a few seconds, then <a href="/">refresh this page</a></li>
                </ol>
            </div>

            <div id="wrong-url-solution" class="solution" style="display: none;">
                <h3>üåê Wrong URL or Port</h3>
                <p>You may be accessing EntityDB on the wrong port or URL.</p>
                <p>Try these URLs:</p>
                <div class="url-box">https://localhost:8085/</div>
                <div class="url-box">https://claude-code.uk.home.arpa:8085/</div>
                <p>Note: EntityDB uses HTTPS on port 8085, not HTTP on port 5000.</p>
            </div>
        </div>

        <div style="margin-top: 32px; text-align: center;">
            <button class="button" onclick="runChecks()">Run Diagnostics Again</button>
        </div>
    </div>

    <script>
        async function checkCurrentPage() {
            const check = document.getElementById('check-current-page');
            const currentUrl = window.location.href;
            
            if (currentUrl.includes(':8085')) {
                setCheckStatus(check, 'success', `Current URL is correct: ${window.location.origin}`);
            } else {
                setCheckStatus(check, 'error', `Wrong port detected. Should be :8085, not ${window.location.port || '80'}`);
                document.getElementById('wrong-url-solution').style.display = 'block';
            }
        }

        async function checkServerHealth() {
            const check = document.getElementById('check-server-health');
            try {
                const response = await fetch('/health', {
                    method: 'GET',
                    mode: 'same-origin',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    setCheckStatus(check, 'success', `Server is healthy (v${data.version})`);
                } else {
                    setCheckStatus(check, 'error', `Server returned status ${response.status}`);
                }
            } catch (error) {
                setCheckStatus(check, 'error', 'Cannot reach server - ' + error.message);
                
                // Check if it's an SSL error
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    document.getElementById('ssl-solution').style.display = 'block';
                } else {
                    document.getElementById('server-down-solution').style.display = 'block';
                }
            }
        }

        async function checkApiAccess() {
            const check = document.getElementById('check-api-access');
            try {
                const response = await fetch('/api/v1/entities/list', {
                    method: 'GET',
                    mode: 'same-origin',
                    cache: 'no-cache'
                });
                
                if (response.status === 401) {
                    setCheckStatus(check, 'success', 'API is accessible (auth required)');
                } else if (response.ok) {
                    setCheckStatus(check, 'success', 'API is accessible');
                } else {
                    setCheckStatus(check, 'error', `API returned status ${response.status}`);
                }
            } catch (error) {
                setCheckStatus(check, 'error', 'Cannot reach API - ' + error.message);
            }
        }

        async function checkSSLCert() {
            const check = document.getElementById('check-ssl-cert');
            
            // This is a bit tricky to check from JavaScript
            // We'll assume if we can reach the health endpoint, SSL is OK
            try {
                const response = await fetch('/health');
                if (response.ok || response.status > 0) {
                    setCheckStatus(check, 'success', 'SSL certificate is accepted');
                }
            } catch (error) {
                if (window.location.protocol === 'https:') {
                    setCheckStatus(check, 'error', 'SSL certificate not trusted by browser');
                    document.getElementById('ssl-solution').style.display = 'block';
                } else {
                    setCheckStatus(check, 'error', 'Not using HTTPS');
                    document.getElementById('wrong-url-solution').style.display = 'block';
                }
            }
        }

        function setCheckStatus(element, status, message) {
            element.className = `check-item ${status}`;
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            element.innerHTML = `<span class="icon">${icon}</span><span>${message}</span>`;
        }

        async function runChecks() {
            // Reset all checks to loading
            document.querySelectorAll('.check-item').forEach(el => {
                el.className = 'check-item loading';
                el.innerHTML = '<span class="icon">‚è≥</span><span>Checking...</span>';
            });
            
            // Hide solutions
            document.getElementById('solutions').style.display = 'none';
            document.querySelectorAll('.solution').forEach(el => el.style.display = 'none');
            
            // Run checks
            await checkCurrentPage();
            await checkServerHealth();
            await checkApiAccess();
            await checkSSLCert();
            
            // Show solutions if any checks failed
            const hasErrors = document.querySelectorAll('.check-item.error').length > 0;
            if (hasErrors) {
                document.getElementById('solutions').style.display = 'block';
            }
        }

        // Run checks on page load
        runChecks();
    </script>
</body>
</html>