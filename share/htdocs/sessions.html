<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB - Session Monitor</title>
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.3/dist/cdn.min.js" defer></script>
    <style>
        .session-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        .session-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .session-user {
            font-weight: bold;
            color: #2c3e50;
        }
        .session-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        .status-expiring {
            background: #fff3cd;
            color: #856404;
        }
        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .session-detail {
            font-size: 12px;
        }
        .detail-label {
            color: #666;
            font-weight: bold;
        }
        .detail-value {
            color: #333;
            margin-top: 2px;
        }
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div x-data="sessionMonitor" x-init="init()" class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>EntityDB Session Monitor</h1>
            </div>
            <div class="header-actions">
                <a href="/" class="btn btn-secondary">← Back to Dashboard</a>
                <a href="/metrics.html" class="btn btn-secondary">Metrics</a>
            </div>
        </header>

        <!-- Login Form (if not authenticated) -->
        <div x-show="!isAuthenticated" class="main-content">
            <div class="login-form">
                <h2>Authentication Required</h2>
                <p class="login-hint">Please login to view session information</p>
                <form @submit.prevent="login">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" x-model="loginForm.username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" x-model="loginForm.password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                    <div x-show="error" class="error" x-text="error"></div>
                </form>
            </div>
        </div>

        <!-- Main Content -->
        <main x-show="isAuthenticated" class="main-content">
            <!-- Controls -->
            <div class="controls">
                <div class="filter-group">
                    <input type="text" x-model="searchTerm" @input="filterSessions" placeholder="Search users...">
                    <select x-model="statusFilter" @change="filterSessions">
                        <option value="">All Sessions</option>
                        <option value="active">Active Only</option>
                        <option value="expiring">Expiring Soon</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="auto-refresh">
                    <label class="checkbox">
                        <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh()">
                        Auto-refresh (10s)
                    </label>
                    <button @click="fetchSessions()" class="btn btn-secondary btn-sm">
                        <span class="icon">↻</span> Refresh
                    </button>
                    <span x-show="loading" class="loading-indicator">Loading...</span>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-number" x-text="stats.total"></div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" x-text="stats.active"></div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" x-text="stats.expiring"></div>
                    <div class="stat-label">Expiring Soon</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" x-text="stats.expired"></div>
                    <div class="stat-label">Expired</div>
                </div>
            </div>

            <!-- Session List -->
            <div x-show="loading" class="loading">Loading sessions...</div>
            
            <div x-show="!loading" class="session-grid">
                <template x-for="session in filteredSessions" :key="session.id">
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-user" x-text="getSessionUsername(session)"></div>
                            <div class="session-status" :class="'status-' + getSessionStatus(session)" 
                                 x-text="getSessionStatus(session)"></div>
                        </div>
                        <div class="session-details">
                            <div class="session-detail">
                                <div class="detail-label">Session ID</div>
                                <div class="detail-value" x-text="truncateId(session.id)"></div>
                            </div>
                            <div class="session-detail">
                                <div class="detail-label">Created</div>
                                <div class="detail-value" x-text="formatDate(getSessionCreated(session))"></div>
                            </div>
                            <div class="session-detail">
                                <div class="detail-label">Expires</div>
                                <div class="detail-value" x-text="formatDate(getSessionExpiry(session))"></div>
                            </div>
                            <div class="session-detail">
                                <div class="detail-label">Time Remaining</div>
                                <div class="detail-value" x-text="getTimeRemaining(session)"></div>
                            </div>
                            <div class="session-detail" x-show="getSessionIP(session)">
                                <div class="detail-label">IP Address</div>
                                <div class="detail-value" x-text="getSessionIP(session)"></div>
                            </div>
                            <div class="session-detail" x-show="getSessionUserAgent(session)">
                                <div class="detail-label">User Agent</div>
                                <div class="detail-value" x-text="truncateUserAgent(getSessionUserAgent(session))"></div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div x-show="!loading && filteredSessions.length === 0" class="empty-state">
                <p>No sessions found matching the current filters.</p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div>EntityDB Session Monitor</div>
            <div>Last Updated: <span x-text="lastUpdated"></span></div>
        </footer>
    </div>

    <script>
    function sessionMonitor() {
        return {
            isAuthenticated: false,
            token: null,
            loading: false,
            autoRefresh: false,
            refreshInterval: null,
            lastUpdated: null,
            
            // Login form
            loginForm: {
                username: '',
                password: ''
            },
            error: '',
            
            // Session data
            sessions: [],
            filteredSessions: [],
            searchTerm: '',
            statusFilter: '',
            
            // Statistics
            stats: {
                total: 0,
                active: 0,
                expiring: 0,
                expired: 0
            },

            async init() {
                // Check for existing auth token
                this.token = localStorage.getItem('authToken');
                if (this.token) {
                    this.isAuthenticated = true;
                    await this.fetchSessions();
                }
            },

            async login() {
                this.loading = true;
                this.error = '';
                
                try {
                    const response = await fetch('/api/v1/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.loginForm)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.token = data.token;
                        localStorage.setItem('authToken', this.token);
                        this.isAuthenticated = true;
                        await this.fetchSessions();
                    } else {
                        this.error = 'Login failed. Please check your credentials.';
                    }
                } catch (error) {
                    this.error = 'Login error: ' + error.message;
                } finally {
                    this.loading = false;
                }
            },

            async fetchSessions() {
                if (!this.token) return;
                
                this.loading = true;
                try {
                    // Fetch entities with type:session
                    const response = await fetch('/api/v1/entities/list?include_content=false', {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        // Filter for session entities
                        this.sessions = (data.entities || []).filter(entity => 
                            entity.tags && entity.tags.some(tag => tag.includes('type:session'))
                        );
                        this.updateStats();
                        this.filterSessions();
                        this.lastUpdated = new Date().toLocaleTimeString();
                    }
                } catch (error) {
                    console.error('Error fetching sessions:', error);
                } finally {
                    this.loading = false;
                }
            },

            filterSessions() {
                let filtered = this.sessions;
                
                // Filter by search term
                if (this.searchTerm) {
                    filtered = filtered.filter(session => 
                        this.getSessionUsername(session).toLowerCase().includes(this.searchTerm.toLowerCase())
                    );
                }
                
                // Filter by status
                if (this.statusFilter) {
                    filtered = filtered.filter(session => 
                        this.getSessionStatus(session) === this.statusFilter
                    );
                }
                
                this.filteredSessions = filtered;
            },

            updateStats() {
                this.stats.total = this.sessions.length;
                this.stats.active = this.sessions.filter(s => this.getSessionStatus(s) === 'active').length;
                this.stats.expiring = this.sessions.filter(s => this.getSessionStatus(s) === 'expiring').length;
                this.stats.expired = this.sessions.filter(s => this.getSessionStatus(s) === 'expired').length;
            },

            toggleAutoRefresh() {
                if (this.autoRefresh) {
                    this.refreshInterval = setInterval(() => {
                        this.fetchSessions();
                    }, 10000);
                } else {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                }
            },

            getSessionUsername(session) {
                if (!session.tags) return 'Unknown';
                const userTag = session.tags.find(tag => tag.includes('user:'));
                return userTag ? userTag.replace('user:', '') : 'Unknown';
            },

            getSessionCreated(session) {
                return session.created_at;
            },

            getSessionExpiry(session) {
                if (!session.tags) return null;
                const expiryTag = session.tags.find(tag => tag.includes('expires_at:'));
                return expiryTag ? expiryTag.replace('expires_at:', '') : null;
            },

            getSessionIP(session) {
                if (!session.tags) return null;
                const ipTag = session.tags.find(tag => tag.includes('ip:'));
                return ipTag ? ipTag.replace('ip:', '') : null;
            },

            getSessionUserAgent(session) {
                if (!session.tags) return null;
                const uaTag = session.tags.find(tag => tag.includes('user_agent:'));
                return uaTag ? uaTag.replace('user_agent:', '') : null;
            },

            getSessionStatus(session) {
                const expiry = this.getSessionExpiry(session);
                if (!expiry) return 'active';
                
                const expiryDate = new Date(expiry);
                const now = new Date();
                const timeLeft = expiryDate - now;
                
                if (timeLeft <= 0) return 'expired';
                if (timeLeft <= 300000) return 'expiring'; // 5 minutes
                return 'active';
            },

            getTimeRemaining(session) {
                const expiry = this.getSessionExpiry(session);
                if (!expiry) return 'No expiry';
                
                const expiryDate = new Date(expiry);
                const now = new Date();
                const timeLeft = expiryDate - now;
                
                if (timeLeft <= 0) return 'Expired';
                
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);
                
                if (hours > 0) return `${hours}h ${minutes}m`;
                return `${minutes}m`;
            },

            truncateId(id) {
                return id ? id.substring(0, 8) + '...' : '';
            },

            truncateUserAgent(ua) {
                return ua && ua.length > 50 ? ua.substring(0, 50) + '...' : ua;
            },

            formatDate(dateStr) {
                if (!dateStr || dateStr === '0001-01-01T00:00:00Z') return 'N/A';
                return new Date(dateStr).toLocaleString();
            }
        };
    }
    </script>
</body>
</html>