<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB Data Integrity Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #334155;
        }
        
        .title {
            font-size: 2rem;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .health-score {
            font-size: 1.5rem;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .health-excellent { background: #065f46; color: #10b981; }
        .health-good { background: #166534; color: #22c55e; }
        .health-warning { background: #7c2d12; color: #fb923c; }
        .health-critical { background: #7f1d1d; color: #ef4444; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .metric-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #cbd5e1;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }
        
        .metric-subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.5s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        
        .chart-container {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
            margin-bottom: 2rem;
        }
        
        .operations-list {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #334155;
        }
        
        .operation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #334155;
        }
        
        .operation-item:last-child {
            border-bottom: none;
        }
        
        .refresh-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .refresh-button:hover {
            background: #2563eb;
        }
        
        .refresh-button:disabled {
            background: #475569;
            cursor: not-allowed;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="dashboard" x-data="integrityDashboard()">
        <div class="header">
            <h1 class="title">Data Integrity Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="health-score" :class="healthScoreClass">
                    Health Score: <span x-text="metrics.health_score?.toFixed(1) || '0'"></span>%
                </div>
                <button class="refresh-button" @click="refreshMetrics" :disabled="loading">
                    <span x-show="!loading">Refresh</span>
                    <span x-show="loading">Loading...</span>
                </button>
            </div>
        </div>
        
        <!-- Entity Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <h3 class="metric-title">Total Entities</h3>
                    <span class="status-indicator" :class="entityHealthClass"></span>
                </div>
                <div class="metric-value" x-text="metrics.entity_metrics?.total_entities || 0"></div>
                <div class="metric-subtitle">
                    <span x-text="metrics.entity_metrics?.corrupted_entities || 0"></span> corrupted,
                    <span x-text="metrics.entity_metrics?.recovered_entities || 0"></span> recovered
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" :style="`width: ${metrics.entity_metrics?.success_rate || 0}%`"></div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <h3 class="metric-title">Index Health</h3>
                    <span class="status-indicator" :class="indexHealthClass"></span>
                </div>
                <div class="metric-value" x-text="metrics.index_metrics?.indexed_entities || 0"></div>
                <div class="metric-subtitle">
                    <span x-show="metrics.index_metrics?.index_healthy">Index Healthy</span>
                    <span x-show="!metrics.index_metrics?.index_healthy" style="color: #ef4444;">Index Issues Detected</span>
                </div>
                <div class="metric-subtitle" style="margin-top: 0.5rem;">
                    Missing: <span x-text="metrics.index_metrics?.missing_from_index || 0"></span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <h3 class="metric-title">Checksum Coverage</h3>
                    <span class="status-indicator" :class="checksumHealthClass"></span>
                </div>
                <div class="metric-value">
                    <span x-text="(metrics.checksum_metrics?.checksum_coverage_percent || 0).toFixed(1)"></span>%
                </div>
                <div class="metric-subtitle">
                    <span x-text="metrics.checksum_metrics?.entities_with_checksum || 0"></span> entities protected
                </div>
                <div class="metric-subtitle" style="margin-top: 0.5rem;">
                    Invalid: <span x-text="metrics.checksum_metrics?.invalid_checksums || 0" 
                                   :style="metrics.checksum_metrics?.invalid_checksums > 0 ? 'color: #ef4444;' : ''"></span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <h3 class="metric-title">Operation Success Rate</h3>
                    <span class="status-indicator" :class="operationHealthClass"></span>
                </div>
                <div class="metric-value">
                    <span x-text="(metrics.operation_metrics?.success_rate || 0).toFixed(1)"></span>%
                </div>
                <div class="metric-subtitle">
                    <span x-text="metrics.operation_metrics?.successful_operations || 0"></span> / 
                    <span x-text="metrics.operation_metrics?.total_operations || 0"></span> operations
                </div>
                <div class="metric-subtitle" style="margin-top: 0.5rem;">
                    Active: <span x-text="metrics.operation_metrics?.active_operations || 0"></span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <h3 class="metric-title">Recovery Success</h3>
                    <span class="status-indicator" :class="recoveryHealthClass"></span>
                </div>
                <div class="metric-value">
                    <span x-text="(metrics.recovery_metrics?.recovery_success_rate || 0).toFixed(1)"></span>%
                </div>
                <div class="metric-subtitle">
                    <span x-text="metrics.recovery_metrics?.successful_recoveries || 0"></span> / 
                    <span x-text="metrics.recovery_metrics?.recovery_attempts || 0"></span> attempts
                </div>
                <div class="metric-subtitle" style="margin-top: 0.5rem;" x-show="metrics.recovery_metrics?.last_recovery_time">
                    Last: <span x-text="formatTime(metrics.recovery_metrics?.last_recovery_time)"></span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <h3 class="metric-title">WAL Status</h3>
                    <span class="status-indicator status-healthy"></span>
                </div>
                <div class="metric-value">
                    <span x-text="metrics.wal_metrics?.wal_entries || 0"></span>
                </div>
                <div class="metric-subtitle">
                    Entries (<span x-text="(metrics.wal_metrics?.wal_size_mb || 0).toFixed(2)"></span> MB)
                </div>
                <div class="metric-subtitle" style="margin-top: 0.5rem;">
                    Corrupted: <span x-text="metrics.wal_metrics?.corrupted_entries || 0"></span>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="chart-container">
            <h3 class="metric-title" style="margin-bottom: 1rem;">Operation Types Distribution</h3>
            <canvas id="operationChart" width="400" height="200"></canvas>
        </div>
        
        <!-- Recent Operations -->
        <div class="operations-list">
            <h3 class="metric-title" style="margin-bottom: 1rem;">Recent Recovery Operations</h3>
            <div x-show="recentRecoveries.length === 0" style="text-align: center; color: #64748b; padding: 2rem;">
                No recent recovery operations
            </div>
            <template x-for="op in recentRecoveries" :key="op.id">
                <div class="operation-item">
                    <div>
                        <div style="font-weight: 500;" x-text="op.entity_id"></div>
                        <div style="font-size: 0.875rem; color: #94a3b8;" x-text="formatTime(op.timestamp)"></div>
                    </div>
                    <div>
                        <span :style="`color: ${op.status === 'completed' ? '#10b981' : '#ef4444'}`" 
                              x-text="op.status"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <script>
        function integrityDashboard() {
            return {
                metrics: {},
                loading: false,
                chart: null,
                
                init() {
                    this.refreshMetrics();
                    // Auto-refresh every 30 seconds
                    setInterval(() => this.refreshMetrics(), 30000);
                },
                
                async refreshMetrics() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/v1/integrity/metrics', {
                            headers: {
                                'Authorization': localStorage.getItem('auth_token') || ''
                            }
                        });
                        
                        if (response.ok) {
                            this.metrics = await response.json();
                            this.updateChart();
                        }
                    } catch (error) {
                        console.error('Failed to fetch metrics:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                get healthScoreClass() {
                    const score = this.metrics.health_score || 0;
                    if (score >= 90) return 'health-excellent';
                    if (score >= 75) return 'health-good';
                    if (score >= 50) return 'health-warning';
                    return 'health-critical';
                },
                
                get entityHealthClass() {
                    const corrupted = this.metrics.entity_metrics?.corrupted_entities || 0;
                    if (corrupted === 0) return 'status-healthy';
                    if (corrupted < 5) return 'status-warning';
                    return 'status-error';
                },
                
                get indexHealthClass() {
                    return this.metrics.index_metrics?.index_healthy ? 'status-healthy' : 'status-error';
                },
                
                get checksumHealthClass() {
                    const coverage = this.metrics.checksum_metrics?.checksum_coverage_percent || 0;
                    const invalid = this.metrics.checksum_metrics?.invalid_checksums || 0;
                    if (invalid > 0) return 'status-error';
                    if (coverage >= 80) return 'status-healthy';
                    if (coverage >= 50) return 'status-warning';
                    return 'status-error';
                },
                
                get operationHealthClass() {
                    const rate = this.metrics.operation_metrics?.success_rate || 0;
                    if (rate >= 95) return 'status-healthy';
                    if (rate >= 80) return 'status-warning';
                    return 'status-error';
                },
                
                get recoveryHealthClass() {
                    const rate = this.metrics.recovery_metrics?.recovery_success_rate || 0;
                    if (rate >= 90) return 'status-healthy';
                    if (rate >= 70) return 'status-warning';
                    return 'status-error';
                },
                
                get recentRecoveries() {
                    // In a real implementation, this would come from the API
                    return [];
                },
                
                formatTime(timestamp) {
                    if (!timestamp) return 'Never';
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                },
                
                updateChart() {
                    const ctx = document.getElementById('operationChart').getContext('2d');
                    const opTypes = this.metrics.operation_metrics?.by_type || {};
                    
                    if (this.chart) {
                        this.chart.destroy();
                    }
                    
                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(opTypes),
                            datasets: [{
                                data: Object.values(opTypes),
                                backgroundColor: [
                                    '#3b82f6',
                                    '#8b5cf6',
                                    '#10b981',
                                    '#f59e0b',
                                    '#ef4444',
                                    '#6366f1',
                                    '#14b8a6',
                                    '#f97316'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: '#e2e8f0',
                                        padding: 20
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>