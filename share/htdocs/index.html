<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB Enhanced Admin Console</title>
    
    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2b6cb0;
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: #48bb78;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Tabs */
        .tabs {
            background: white;
            border-radius: 8px 8px 0 0;
            padding: 0;
            margin-bottom: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #2b6cb0;
            background: #f7fafc;
        }

        .tab-button.active {
            color: #2b6cb0;
            border-bottom-color: #2b6cb0;
            background: #f7fafc;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Grid layouts */
        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .grid-4 {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        /* Metric cards */
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .table tr:hover {
            background: #f7fafc;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #2b6cb0;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5aa0;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h2 {
            color: #2d3748;
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #718096;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #2d3748;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2b6cb0;
            box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.1);
        }

        /* Tags */
        .tag {
            display: inline-block;
            background: #edf2f7;
            color: #2d3748;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }

        .tag.system {
            background: #fbb6ce;
            color: #702459;
        }

        .tag.user {
            background: #bee3f8;
            color: #2a69ac;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .alert-warning {
            background: #fefcbf;
            color: #744210;
            border: 1px solid #f6e05e;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2b6cb0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .tab-buttons {
                flex-wrap: wrap;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>EntityDB Enhanced Admin Console</h1>
            <div class="user-info">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Connected</span>
                </div>
                <span id="currentUser">Loading...</span>
                <button class="btn btn-secondary btn-sm" onclick="app.logout()">Logout</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab-button" onclick="switchTab('entities')">Entities</button>
                <button class="tab-button" onclick="switchTab('performance')">Performance</button>
                <button class="tab-button" onclick="switchTab('metrics')">Metrics</button>
                <button class="tab-button" onclick="switchTab('users')">Users</button>
                <button class="tab-button" onclick="switchTab('system')">System</button>
                <button class="tab-button" onclick="switchTab('api')">API Console</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="grid grid-4">
                    <div class="metric-card">
                        <div class="metric-value" id="totalEntities">-</div>
                        <div class="metric-label">Total Entities</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="activeUsers">-</div>
                        <div class="metric-label">Active Users</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="activeSessions">-</div>
                        <div class="metric-label">Active Sessions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="systemHealth">-</div>
                        <div class="metric-label">System Health</div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3>System Performance</h3>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Memory Usage</h3>
                        <div class="chart-container">
                            <canvas id="memoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity">Loading...</div>
                </div>
            </div>

            <!-- Entities Tab -->
            <div id="entities" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Entity Management</h3>
                        <button class="btn btn-primary" onclick="app.showCreateEntityModal()">Create Entity</button>
                    </div>
                    
                    <div class="form-group" style="max-width: 400px;">
                        <input type="text" id="entitySearch" placeholder="Search entities..." 
                               onkeyup="app.searchEntities()" style="margin-bottom: 15px;">
                    </div>
                    
                    <div id="entitiesTable">Loading entities...</div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performance" class="tab-content">
                <div class="grid grid-3">
                    <div class="metric-card">
                        <div class="metric-value" id="avgResponseTime">-</div>
                        <div class="metric-label">Avg Response Time (ms)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="requestsPerSecond">-</div>
                        <div class="metric-label">Requests/Second</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="errorRate">-</div>
                        <div class="metric-label">Error Rate (%)</div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3>Response Time Trends</h3>
                        <div class="chart-container">
                            <canvas id="responseTimeChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Request Volume</h3>
                        <div class="chart-container">
                            <canvas id="requestVolumeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Storage Performance</h3>
                    <div class="grid grid-2">
                        <div class="chart-container">
                            <canvas id="storageReadChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="storageWriteChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Tab -->
            <div id="metrics" class="tab-content">
                <div class="card">
                    <h3>Live Metrics Dashboard</h3>
                    <div id="metricsData">Loading metrics...</div>
                </div>

                <div class="card">
                    <h3>Custom Metrics Query</h3>
                    <div class="form-group">
                        <label>Metric Name:</label>
                        <input type="text" id="metricName" placeholder="e.g., storage_read_duration_ms">
                    </div>
                    <div class="form-group">
                        <label>Time Range:</label>
                        <select id="timeRange">
                            <option value="1h">Last Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="app.queryMetrics()">Query Metrics</button>
                    
                    <div id="customMetricsChart" class="chart-container" style="display: none;">
                        <canvas id="customChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>User Management</h3>
                        <button class="btn btn-primary" onclick="app.showCreateUserModal()">Create User</button>
                    </div>
                    <div id="usersTable">Loading users...</div>
                </div>
            </div>

            <!-- System Tab -->
            <div id="system" class="tab-content">
                <div class="grid grid-2">
                    <div class="card">
                        <h3>System Information</h3>
                        <div id="systemInfo">Loading...</div>
                    </div>
                    <div class="card">
                        <h3>Database Statistics</h3>
                        <div id="dbStats">Loading...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>System Logs</h3>
                    <div style="max-height: 400px; overflow-y: auto; background: #f7fafc; padding: 15px; border-radius: 6px;">
                        <div id="systemLogs">Loading logs...</div>
                    </div>
                </div>
            </div>

            <!-- API Console Tab -->
            <div id="api" class="tab-content">
                <div class="card">
                    <h3>API Testing Console</h3>
                    <div class="grid grid-2">
                        <div>
                            <div class="form-group">
                                <label>HTTP Method:</label>
                                <select id="apiMethod">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Endpoint:</label>
                                <input type="text" id="apiEndpoint" value="/api/v1/entities/list">
                            </div>
                            <div class="form-group">
                                <label>Request Body (JSON):</label>
                                <textarea id="apiBody" rows="10" placeholder='{"key": "value"}'></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="app.testAPI()">Send Request</button>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>Response:</label>
                                <textarea id="apiResponse" rows="20" readonly style="font-family: monospace; background: #f7fafc;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced EntityDB Admin Application
        class EntityDBAdmin {
            constructor() {
                this.baseURL = window.location.origin;
                this.token = localStorage.getItem('entitydb_token');
                this.refreshInterval = null;
                this.charts = {};
                
                if (this.token) {
                    this.init();
                } else {
                    this.showLogin();
                }
            }

            async init() {
                console.log('Initializing Enhanced EntityDB Admin...');
                await this.refreshData();
                this.startAutoRefresh();
                this.initCharts();
            }

            showLogin() {
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f7fa;">
                        <div class="card" style="width: 400px; margin: 0;">
                            <h2 style="text-align: center; margin-bottom: 30px; color: #2b6cb0;">EntityDB Login</h2>
                            <div class="form-group">
                                <label>Username:</label>
                                <input type="text" id="username" value="admin">
                            </div>
                            <div class="form-group">
                                <label>Password:</label>
                                <input type="password" id="password" value="admin">
                            </div>
                            <button class="btn btn-primary" style="width: 100%;" onclick="app.login()">Login</button>
                            <div id="loginError" style="margin-top: 15px;"></div>
                        </div>
                    </div>
                `;
                
                // Handle enter key
                document.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
            }

            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    const response = await fetch(`${this.baseURL}/api/v1/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.token = data.token;
                        localStorage.setItem('entitydb_token', this.token);
                        location.reload();
                    } else {
                        document.getElementById('loginError').innerHTML = 
                            `<div class="alert alert-error">${data.error || 'Login failed'}</div>`;
                    }
                } catch (error) {
                    document.getElementById('loginError').innerHTML = 
                        `<div class="alert alert-error">Connection error: ${error.message}</div>`;
                }
            }

            logout() {
                localStorage.removeItem('entitydb_token');
                location.reload();
            }

            async apiCall(endpoint, method = 'GET', body = null) {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`
                };

                const config = { method, headers };
                if (body) config.body = JSON.stringify(body);

                const response = await fetch(`${this.baseURL}${endpoint}`, config);
                
                if (response.status === 401) {
                    this.logout();
                    return;
                }
                
                return await response.json();
            }

            async refreshData() {
                try {
                    // Update connection status
                    document.getElementById('connectionStatus').textContent = 'Connected';
                    
                    // Load dashboard data
                    await this.loadDashboardData();
                    await this.loadEntities();
                    await this.loadUsers();
                    await this.loadSystemInfo();
                    await this.loadMetrics();
                    
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    document.getElementById('connectionStatus').textContent = 'Error';
                }
            }

            async loadDashboardData() {
                try {
                    const [entities, health, users] = await Promise.all([
                        this.apiCall('/api/v1/entities/list'),
                        this.apiCall('/health'),
                        this.apiCall('/api/v1/rbac/metrics/public')
                    ]);

                    document.getElementById('totalEntities').textContent = entities.length || 0;
                    document.getElementById('activeUsers').textContent = users.active_users || 0;
                    document.getElementById('activeSessions').textContent = users.active_sessions || 0;
                    document.getElementById('systemHealth').textContent = health.status === 'healthy' ? '100%' : '50%';

                    // Update current user
                    const userEntities = entities.filter(e => e.tags?.some(t => t.includes('type:user')));
                    document.getElementById('currentUser').textContent = 'Admin User';

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }

            async loadEntities() {
                try {
                    const entities = await this.apiCall('/api/v1/entities/list');
                    
                    const tableHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Created</th>
                                    <th>Tags</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entities.map(entity => `
                                    <tr>
                                        <td>${entity.id.substring(0, 12)}...</td>
                                        <td>${this.getEntityType(entity)}</td>
                                        <td>${this.formatDate(entity.created_at)}</td>
                                        <td>${entity.tags?.length || 0} tags</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="app.viewEntity('${entity.id}')">View</button>
                                            <button class="btn btn-sm btn-secondary" onclick="app.editEntity('${entity.id}')">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('entitiesTable').innerHTML = tableHTML;
                } catch (error) {
                    document.getElementById('entitiesTable').innerHTML = `<div class="alert alert-error">Error loading entities: ${error.message}</div>`;
                }
            }

            async loadUsers() {
                try {
                    const entities = await this.apiCall('/api/v1/entities/list');
                    const users = entities.filter(e => e.tags?.some(t => t.includes('type:user')));
                    
                    const tableHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Status</th>
                                    <th>Roles</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.id.substring(0, 12)}...</td>
                                        <td>${this.extractTagValue(user, 'identity:username')}</td>
                                        <td><span class="tag">${this.extractTagValue(user, 'status')}</span></td>
                                        <td>${this.extractTagValue(user, 'rbac:role')}</td>
                                        <td>${this.formatDate(user.created_at)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="app.viewEntity('${user.id}')">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    document.getElementById('usersTable').innerHTML = tableHTML;
                } catch (error) {
                    document.getElementById('usersTable').innerHTML = `<div class="alert alert-error">Error loading users: ${error.message}</div>`;
                }
            }

            async loadSystemInfo() {
                try {
                    const [health, metrics] = await Promise.all([
                        this.apiCall('/health'),
                        this.apiCall('/api/v1/system/metrics')
                    ]);

                    document.getElementById('systemInfo').innerHTML = `
                        <div style="display: grid; gap: 10px;">
                            <div><strong>Status:</strong> ${health.status}</div>
                            <div><strong>Uptime:</strong> ${health.uptime || 'N/A'}</div>
                            <div><strong>Version:</strong> ${health.version || 'N/A'}</div>
                            <div><strong>Memory:</strong> ${this.formatBytes(health.memory?.used || 0)}</div>
                        </div>
                    `;

                    document.getElementById('dbStats').innerHTML = `
                        <div style="display: grid; gap: 10px;">
                            <div><strong>Total Entities:</strong> ${metrics.entity_count || 0}</div>
                            <div><strong>Database Size:</strong> ${this.formatBytes(metrics.database_size || 0)}</div>
                            <div><strong>WAL Size:</strong> ${this.formatBytes(metrics.wal_size || 0)}</div>
                            <div><strong>Index Size:</strong> ${this.formatBytes(metrics.index_size || 0)}</div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading system info:', error);
                }
            }

            async loadMetrics() {
                try {
                    // Load metrics from the new async system
                    const entities = await this.apiCall('/api/v1/entities/list');
                    const metrics = entities.filter(e => e.tags?.some(t => t.includes('type:metric')));
                    
                    const metricsHTML = `
                        <div class="grid grid-2">
                            <div>
                                <h4>Available Metrics (${metrics.length})</h4>
                                <ul style="list-style: none; padding: 0;">
                                    ${metrics.map(metric => `
                                        <li style="padding: 5px 0; border-bottom: 1px solid #eee;">
                                            <strong>${this.extractTagValue(metric, 'name')}</strong>
                                            <br><small>${this.extractTagValue(metric, 'description')}</small>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4>Recent Values</h4>
                                <div id="metricValues">
                                    ${metrics.slice(0, 10).map(metric => `
                                        <div style="padding: 5px 0;">
                                            <strong>${this.extractTagValue(metric, 'name')}:</strong>
                                            ${this.getLatestValue(metric)} ${this.extractTagValue(metric, 'unit')}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('metricsData').innerHTML = metricsHTML;
                } catch (error) {
                    document.getElementById('metricsData').innerHTML = `<div class="alert alert-error">Error loading metrics: ${error.message}</div>`;
                }
            }

            initCharts() {
                // Initialize performance chart
                const performanceCtx = document.getElementById('performanceChart');
                if (performanceCtx) {
                    this.charts.performance = new Chart(performanceCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Response Time (ms)',
                                data: [],
                                borderColor: '#2b6cb0',
                                backgroundColor: 'rgba(43, 108, 176, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // Initialize memory chart
                const memoryCtx = document.getElementById('memoryChart');
                if (memoryCtx) {
                    this.charts.memory = new Chart(memoryCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Used', 'Free'],
                            datasets: [{
                                data: [60, 40],
                                backgroundColor: ['#e53e3e', '#38a169']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }

            async viewEntity(entityId) {
                try {
                    const entity = await this.apiCall(`/api/v1/entities/get?id=${entityId}`);
                    this.showEntityModal(entity, false);
                } catch (error) {
                    this.showAlert('Failed to load entity: ' + error.message, 'error');
                }
            }

            async editEntity(entityId) {
                try {
                    const entity = await this.apiCall(`/api/v1/entities/get?id=${entityId}`);
                    this.showEntityModal(entity, true);
                } catch (error) {
                    this.showAlert('Failed to load entity: ' + error.message, 'error');
                }
            }

            showEntityModal(entity, isEdit) {
                const modalId = 'entityModal';
                let modal = document.getElementById(modalId);
                
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = modalId;
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                }

                const entityType = this.getEntityType(entity);
                const tagsDisplay = entity.tags ? entity.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ') : '';
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${isEdit ? 'Edit' : 'View'} Entity</h2>
                            <span class="close" onclick="app.closeModal('${modalId}')">&times;</span>
                        </div>
                        
                        <div class="form-group">
                            <label>ID:</label>
                            <input type="text" value="${entity.id}" readonly style="background: #f5f5f5;">
                        </div>
                        
                        <div class="form-group">
                            <label>Type:</label>
                            <input type="text" value="${entityType}" readonly style="background: #f5f5f5;">
                        </div>
                        
                        <div class="form-group">
                            <label>Tags:</label>
                            <div style="border: 1px solid #e2e8f0; padding: 15px; min-height: 100px; background: white; border-radius: 6px;">
                                ${tagsDisplay}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Content:</label>
                            <textarea id="entityContent" style="width: 100%; height: 200px; ${isEdit ? '' : 'background: #f5f5f5;'}" ${isEdit ? '' : 'readonly'}>${entity.content || ''}</textarea>
                        </div>
                        
                        <div style="text-align: right; margin-top: 20px;">
                            ${isEdit ? `
                                <button class="btn btn-primary" onclick="app.saveEntity('${entity.id}')">Save Changes</button>
                                <button class="btn btn-secondary" onclick="app.closeModal('${modalId}')">Cancel</button>
                            ` : `
                                <button class="btn btn-secondary" onclick="app.closeModal('${modalId}')">Close</button>
                            `}
                        </div>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            async testAPI() {
                const method = document.getElementById('apiMethod').value;
                const endpoint = document.getElementById('apiEndpoint').value;
                const body = document.getElementById('apiBody').value;
                
                try {
                    const result = await this.apiCall(endpoint, method, body ? JSON.parse(body) : null);
                    document.getElementById('apiResponse').value = JSON.stringify(result, null, 2);
                } catch (error) {
                    document.getElementById('apiResponse').value = `Error: ${error.message}`;
                }
            }

            startAutoRefresh() {
                if (this.refreshInterval) clearInterval(this.refreshInterval);
                this.refreshInterval = setInterval(() => this.refreshData(), 30000);
            }

            // Utility functions
            getEntityType(entity) {
                if (!entity.tags) return 'unknown';
                const typeTag = entity.tags.find(tag => tag.includes('type:'));
                return typeTag ? typeTag.split('type:')[1].split('|')[0] : 'unknown';
            }

            extractTagValue(entity, tagKey) {
                if (!entity.tags) return 'N/A';
                const tag = entity.tags.find(t => t.includes(tagKey + ':'));
                return tag ? tag.split(tagKey + ':')[1].split('|')[0] : 'N/A';
            }

            getLatestValue(metric) {
                if (!metric.tags) return '0';
                const valueTag = metric.tags.find(t => t.includes('value:'));
                return valueTag ? valueTag.split('value:')[1].split('|')[0] : '0';
            }

            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                return new Date(timestamp).toLocaleDateString();
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            showAlert(message, type = 'success') {
                const alertHTML = `<div class="alert alert-${type}">${message}</div>`;
                // You can implement this to show alerts in a toast or modal
                console.log(alertHTML);
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Initialize application
        const app = new EntityDBAdmin();
    </script>
</body>
</html>