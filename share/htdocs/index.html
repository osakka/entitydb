<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB Control Center - Temporal Datasets</title>
    
    <!-- Vue 3 Production Build -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- CSS -->
    <link href="/css/design-system.css" rel="stylesheet">
    
    <!-- Core scripts -->
    <script src="/js/logger.js"></script>
    <script src="/js/api-client.js"></script>
    <script src="/js/notification-system.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        body.dark-mode {
            background: #1a1d21;
            color: #e1e8ed;
        }

        [v-cloak] {
            display: none;
        }

        /* App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .app-header {
            background: #ffffff;
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body.dark-mode .app-header {
            background: #2c3e50;
            color: #e1e8ed;
            border-bottom-color: #34495e;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
        }

        .app-logo {
            display: flex;
            align-items: center;
            margin-left: 20px;
        }

        .app-logo img {
            height: 36px;
            transform: scale(1.53);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            overflow-x: auto;
        }

        body.dark-mode .nav-tabs {
            background: #2c3e50;
            border-bottom-color: #34495e;
        }

        .nav-tab {
            padding: 16px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .nav-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        body.dark-mode .nav-tab {
            color: #95a5a6;
        }

        body.dark-mode .nav-tab:hover {
            color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: #f5f6fa;
            padding: 20px;
        }

        body.dark-mode .main-content {
            background: #1a1d21;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Login Form */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 64px);
        }

        .login-card {
            background: white;
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        body.dark-mode .login-card {
            background: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        body.dark-mode .form-label {
            color: #e1e8ed;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        body.dark-mode .form-input {
            background: #34495e;
            border-color: #415a77;
            color: #e1e8ed;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Dashboard */
        .dashboard-container {
            padding: 24px;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .dashboard-header {
            background: rgba(44, 62, 80, 0.9);
        }

        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .widget {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        body.dark-mode .widget {
            background: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .widget-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .widget-header {
            border-bottom-color: #34495e;
        }

        .widget-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        }

        body.dark-mode .widget-title {
            color: #e1e8ed;
        }

        .widget-content {
            padding: 20px;
        }

        /* Metric Card */
        .metric-card {
            text-align: center;
            padding: 20px;
        }

        .metric-value {
            font-size: 48px;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        body.dark-mode .btn-secondary {
            background: #34495e;
            color: #e1e8ed;
        }

        body.dark-mode .btn-secondary:hover {
            background: #415a77;
        }

        /* Dataset selector */
        .dataset-selector {
            background: transparent;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
        }

        body.dark-mode .dataset-selector {
            color: #e1e8ed;
            border-color: #34495e;
        }

        /* Dark mode toggle */
        .dark-mode-toggle {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 20px;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .dark-mode-toggle:hover {
            background: rgba(0,0,0,0.05);
        }

        body.dark-mode .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="app-container">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <div class="app-logo">
                        <img :src="isDarkMode ? '/logo_white.svg' : '/logo_black.svg'" alt="EntityDB">
                    </div>
                    <span v-if="isAuthenticated" style="color: #6c757d; font-size: 14px;">
                        v2.29.0 | 
                        <select v-model="currentDataset" @change="switchDataset" class="dataset-selector">
                            <option value="default">default</option>
                            <option value="_system">_system</option>
                            <option value="test">test</option>
                        </select>
                    </span>
                </div>
                <div class="header-right" style="display: flex; align-items: center; gap: 16px;">
                    <template v-if="isAuthenticated">
                        <button @click="toggleDarkMode" class="dark-mode-toggle" :title="isDarkMode ? 'Light Mode' : 'Dark Mode'">
                            <i :class="isDarkMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
                        </button>
                        <div class="user-info" style="display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(0, 0, 0, 0.05); border-radius: 8px;">
                            <i class="fas fa-user-circle" style="font-size: 24px; color: #3498db;"></i>
                            <span style="font-weight: 500;">{{ currentUser.username }}</span>
                        </div>
                        <button @click="logout" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </template>
                </div>
            </header>

            <!-- Navigation -->
            <nav v-if="isAuthenticated" class="nav-tabs">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="switchTab(tab.id)"
                    :class="['nav-tab', { active: activeTab === tab.id }]"
                >
                    <i :class="tab.icon"></i> {{ tab.name }}
                </button>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Login Screen -->
                <div v-if="!isAuthenticated" class="login-container">
                    <div class="login-card">
                        <h2 style="margin-bottom: 32px; text-align: center;">Login to EntityDB</h2>
                        <form @submit.prevent="login">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input 
                                    v-model="loginForm.username" 
                                    type="text" 
                                    class="form-input"
                                    placeholder="Enter username"
                                    required
                                >
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input 
                                    v-model="loginForm.password" 
                                    type="password" 
                                    class="form-input"
                                    placeholder="Enter password"
                                    required
                                >
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;" :disabled="loading">
                                <span v-if="loading" class="spinner"></span>
                                <i v-else class="fas fa-sign-in-alt"></i> 
                                {{ loading ? 'Logging in...' : 'Login' }}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Tab Contents -->
                <template v-if="isAuthenticated">
                    <!-- Dashboard Tab -->
                    <div :class="['tab-content', { active: activeTab === 'dashboard' }]">
                        <div class="dashboard-container">
                            <div class="dashboard-header">
                                <div>
                                    <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Dashboard</h2>
                                    <span style="color: #6c757d; font-size: 14px;">System metrics and monitoring</span>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button @click="loadSystemStats" class="btn btn-secondary">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>

                            <div class="widget-grid">
                                <!-- Entity Count Widget -->
                                <div class="widget">
                                    <div class="widget-header">
                                        <h3 class="widget-title">Total Entities</h3>
                                    </div>
                                    <div class="widget-content">
                                        <div class="metric-card">
                                            <div class="metric-value">{{ systemStats.totalEntities || 0 }}</div>
                                            <div class="metric-label">Entities</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- User Count Widget -->
                                <div class="widget">
                                    <div class="widget-header">
                                        <h3 class="widget-title">Active Users</h3>
                                    </div>
                                    <div class="widget-content">
                                        <div class="metric-card">
                                            <div class="metric-value">{{ systemStats.activeUsers || 0 }}</div>
                                            <div class="metric-label">Users</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Memory Usage Widget -->
                                <div class="widget">
                                    <div class="widget-header">
                                        <h3 class="widget-title">Memory Usage</h3>
                                    </div>
                                    <div class="widget-content">
                                        <div class="metric-card">
                                            <div class="metric-value">{{ systemStats.memoryUsage || '0 MB' }}</div>
                                            <div class="metric-label">Memory</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Health Score Widget -->
                                <div class="widget">
                                    <div class="widget-header">
                                        <h3 class="widget-title">Health Score</h3>
                                    </div>
                                    <div class="widget-content">
                                        <div class="metric-card">
                                            <div class="metric-value" style="color: #10b981;">{{ systemStats.healthScore || 0 }}%</div>
                                            <div class="metric-label">System Health</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Entities Tab -->
                    <div :class="['tab-content', { active: activeTab === 'entities' }]">
                        <div style="padding: 24px;">
                            <h2>Entity Browser</h2>
                            <p style="color: #6c757d; margin-top: 16px;">Browse and manage entities in the system.</p>
                            <div id="entity-browser-container" style="margin-top: 24px;"></div>
                        </div>
                    </div>

                    <!-- Performance Tab -->
                    <div :class="['tab-content', { active: activeTab === 'performance' }]">
                        <div style="padding: 24px;">
                            <h2>Performance Monitoring</h2>
                            <p style="color: #6c757d; margin-top: 16px;">Advanced performance metrics and analysis.</p>
                        </div>
                    </div>

                    <!-- RBAC Tab -->
                    <div :class="['tab-content', { active: activeTab === 'rbac' }]">
                        <div style="padding: 24px;">
                            <h2>RBAC Management</h2>
                            <p style="color: #6c757d; margin-top: 16px;">Role-based access control and user management.</p>
                        </div>
                    </div>

                    <!-- Integrity Tab -->
                    <div :class="['tab-content', { active: activeTab === 'integrity' }]">
                        <div style="padding: 24px;">
                            <h2>Data Integrity</h2>
                            <p style="color: #6c757d; margin-top: 16px;">Check and maintain data integrity.</p>
                        </div>
                    </div>

                    <!-- Admin Tab -->
                    <div :class="['tab-content', { active: activeTab === 'admin' }]">
                        <div style="padding: 24px;">
                            <h2>Admin Panel</h2>
                            <p style="color: #6c757d; margin-top: 16px;">System administration and dataset management.</p>
                        </div>
                    </div>
                </template>
            </main>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Auth state
                    isAuthenticated: false,
                    sessionToken: null,
                    currentUser: null,
                    currentDataset: 'default',
                    
                    // Login form
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    
                    // Navigation
                    activeTab: 'dashboard',
                    tabs: [
                        { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-th-large' },
                        { id: 'entities', name: 'Entities', icon: 'fas fa-database' },
                        { id: 'performance', name: 'Performance', icon: 'fas fa-tachometer-alt' },
                        { id: 'rbac', name: 'RBAC Metrics', icon: 'fas fa-user-shield' },
                        { id: 'integrity', name: 'Integrity', icon: 'fas fa-shield-alt' },
                        { id: 'admin', name: 'Admin', icon: 'fas fa-cog' }
                    ],
                    
                    // Dark mode
                    isDarkMode: false,
                    
                    // System data
                    systemStats: {},
                    
                    // UI state
                    loading: false,
                    
                    // Infrastructure
                    logger: null,
                    api: null
                };
            },
            
            created() {
                // Initialize logger and API client
                this.logger = window.Logger ? new window.Logger('Dashboard') : console;
                this.api = window.EntityDBClient ? new window.EntityDBClient() : null;
                this.logger.info('EntityDB Dashboard created');
            },
            
            mounted() {
                this.logger.info('EntityDB Dashboard mounted');
                
                // Check for saved auth
                const token = localStorage.getItem('entitydb-admin-token');
                const user = localStorage.getItem('entitydb-admin-user');
                const darkMode = localStorage.getItem('entitydb-dark-mode') === 'true';
                
                if (token && user) {
                    try {
                        this.sessionToken = token;
                        this.currentUser = JSON.parse(user);
                        this.isAuthenticated = true;
                        this.loadSystemStats();
                    } catch (e) {
                        console.error('Failed to restore session:', e);
                        localStorage.removeItem('entitydb-admin-token');
                        localStorage.removeItem('entitydb-admin-user');
                    }
                }
                
                // Apply dark mode
                this.isDarkMode = darkMode;
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                }
                
                // Auto-refresh system stats
                setInterval(() => {
                    if (this.isAuthenticated) {
                        this.loadSystemStats();
                    }
                }, 30000);
            },
            
            methods: {
                // Authentication
                async login() {
                    this.loading = true;
                    this.logger.info('Attempting login', { username: this.loginForm.username });
                    
                    try {
                        if (!this.api) {
                            throw new Error('API client not available');
                        }
                        
                        const data = await this.api.login(this.loginForm.username, this.loginForm.password);
                        
                        this.logger.info('Login successful', { user: data.user });
                        
                        this.sessionToken = data.token;
                        this.currentUser = data.user;
                        this.isAuthenticated = true;
                        
                        // Update API client token
                        this.api.setToken(data.token);
                        
                        // Save to localStorage
                        localStorage.setItem('entitydb-admin-token', data.token);
                        localStorage.setItem('entitydb-admin-user', JSON.stringify(data.user));
                        
                        this.notify('Login successful!', 'success');
                        
                        this.loadSystemStats();
                    } catch (error) {
                        this.logger.error('Login failed', error);
                        this.notify(error.message || 'Login failed', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                logout() {
                    this.logger.info('User logout');
                    this.isAuthenticated = false;
                    this.sessionToken = null;
                    this.currentUser = null;
                    if (this.api) {
                        this.api.setToken(null);
                    }
                    localStorage.removeItem('entitydb-admin-token');
                    localStorage.removeItem('entitydb-admin-user');
                    this.notify('Logged out', 'info');
                },
                
                // Tab switching
                switchTab(tabId) {
                    console.log(`Switching from tab '${this.activeTab}' to '${tabId}'`);
                    this.activeTab = tabId;
                    
                    // Initialize entity browser when entities tab is accessed
                    if (tabId === 'entities' && window.entityBrowser && !window.entityBrowserInitialized) {
                        this.$nextTick(() => {
                            const container = document.getElementById('entity-browser-container');
                            if (container) {
                                // Share the API client with entity browser
                                window.apiClient = this.api;
                                window.entityBrowser.mount(container);
                                window.entityBrowserInitialized = true;
                            }
                        });
                    }
                },
                
                // Dark mode
                toggleDarkMode() {
                    this.isDarkMode = !this.isDarkMode;
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('entitydb-dark-mode', this.isDarkMode);
                    this.logger.debug('Dark mode toggled', { darkMode: this.isDarkMode });
                },
                
                // Dataset
                switchDataset() {
                    this.notify(`Switched to ${this.currentDataset} dataset`, 'info');
                    this.loadSystemStats();
                },
                
                // System data
                async loadSystemStats() {
                    try {
                        const response = await fetch('/health');
                        if (response.ok) {
                            const data = await response.json();
                            this.systemStats = {
                                totalEntities: data.metrics.entity_count || 0,
                                activeUsers: data.metrics.user_count || 0,
                                memoryUsage: this.formatBytes(data.metrics.memory_usage?.alloc_bytes || 0),
                                goroutines: data.metrics.goroutines || 0,
                                uptime: this.formatUptime(data.uptime || '0h0m'),
                                version: data.version || 'unknown',
                                healthScore: Math.round((data.metrics.entity_count > 0 ? 90 : 0) + (data.metrics.goroutines < 100 ? 10 : 0))
                            };
                        }
                    } catch (error) {
                        console.error('Error loading stats:', error);
                        // Set default values on error
                        this.systemStats = {
                            totalEntities: 0,
                            activeUsers: 0,
                            memoryUsage: '0 B',
                            goroutines: 0,
                            uptime: '0h 0m',
                            version: 'unknown',
                            healthScore: 0
                        };
                    }
                },
                
                // Notifications
                notify(message, type = 'info') {
                    if (window.notificationSystem) {
                        window.notificationSystem.show(message, type);
                    } else {
                        console.log(`[${type.toUpperCase()}] ${message}`);
                    }
                },
                
                // Utilities
                formatBytes(bytes) {
                    const units = ['B', 'KB', 'MB', 'GB'];
                    let i = 0;
                    while (bytes > 1024 && i < units.length - 1) {
                        bytes /= 1024;
                        i++;
                    }
                    return Math.round(bytes) + ' ' + units[i];
                },
                
                formatUptime(uptime) {
                    // Parse Go duration string
                    const match = uptime.match(/(\d+)h(\d+)m/);
                    if (match) {
                        return `${match[1]}h ${match[2]}m`;
                    }
                    return uptime;
                }
            }
        }).mount('#app');
    </script>

    <!-- Load entity browser if available -->
    <script src="/js/entity-browser.js"></script>
</body>
</html>