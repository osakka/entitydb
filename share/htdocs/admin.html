<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB - Admin Panel</title>
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.3/dist/cdn.min.js" defer></script>
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .admin-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .user-info {
            flex: 1;
        }
        .username {
            font-weight: bold;
            color: #2c3e50;
        }
        .user-roles {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .user-actions {
            display: flex;
            gap: 5px;
        }
        .role-badge {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .role-admin {
            background: #e74c3c;
        }
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div x-data="adminPanel" x-init="init()" class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>EntityDB Admin Panel</h1>
            </div>
            <div class="header-actions">
                <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
                <a href="/metrics.html" class="btn btn-secondary">Metrics</a>
                <a href="/sessions.html" class="btn btn-secondary">Sessions</a>
            </div>
        </header>

        <!-- Login Form (if not authenticated or not admin) -->
        <div x-show="!isAuthenticated || !isAdmin" class="main-content">
            <div class="login-form">
                <h2>Admin Access Required</h2>
                <p class="login-hint">Please login with admin credentials</p>
                <form @submit.prevent="login">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" x-model="loginForm.username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" x-model="loginForm.password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                    <div x-show="error" class="error" x-text="error"></div>
                </form>
            </div>
        </div>

        <!-- Main Content -->
        <main x-show="isAuthenticated && isAdmin" class="main-content">
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-box">
                    <div class="stat-number" x-text="stats.totalUsers"></div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" x-text="stats.activeUsers"></div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" x-text="stats.adminUsers"></div>
                    <div class="stat-label">Administrators</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" x-text="stats.activeSessions"></div>
                    <div class="stat-label">Active Sessions</div>
                </div>
            </div>

            <div class="admin-grid">
                <!-- User Management -->
                <div class="admin-card">
                    <div class="card-title">User Management</div>
                    
                    <div class="action-bar">
                        <input type="text" x-model="userSearch" @input="filterUsers" placeholder="Search users...">
                        <button @click="showCreateUserModal = true" class="btn btn-primary btn-sm">
                            + Add User
                        </button>
                    </div>

                    <div x-show="loading" class="loading">Loading users...</div>
                    
                    <div x-show="!loading" class="user-list">
                        <template x-for="user in filteredUsers" :key="user.id">
                            <div class="user-item">
                                <div class="user-info">
                                    <div class="username" x-text="getUserUsername(user)"></div>
                                    <div class="user-roles">
                                        <template x-for="role in getUserRoles(user)" :key="role">
                                            <span class="role-badge" :class="{'role-admin': role === 'admin'}" x-text="role"></span>
                                        </template>
                                    </div>
                                </div>
                                <div class="user-actions">
                                    <button @click="resetPassword(user)" class="btn btn-sm btn-secondary" title="Reset Password">
                                        üîë
                                    </button>
                                    <button @click="editUser(user)" class="btn btn-sm btn-secondary" title="Edit User">
                                        ‚úèÔ∏è
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- System Health -->
                <div class="admin-card">
                    <div class="card-title">System Health</div>
                    
                    <div x-show="health">
                        <div style="margin-bottom: 15px;">
                            <strong>Status:</strong> 
                            <span :style="getHealthStyle()" x-text="health?.status || 'Unknown'"></span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Uptime:</strong> <span x-text="formatUptime(health?.uptime || 0)"></span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Memory:</strong> <span x-text="formatBytes(health?.metrics?.memory_alloc || 0)"></span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Entities:</strong> <span x-text="health?.metrics?.entity_count || 0"></span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Database Size:</strong> <span x-text="formatBytes(health?.metrics?.database_size || 0)"></span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button @click="fetchHealth()" class="btn btn-secondary btn-sm">
                            ‚Üª Refresh Health
                        </button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="admin-card">
                    <div class="card-title">Recent Activity</div>
                    
                    <div x-show="dashboardStats?.recent_activity" style="max-height: 250px; overflow-y: auto;">
                        <template x-for="activity in dashboardStats.recent_activity.slice(0, 10)" :key="activity.description">
                            <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                <div style="font-size: 13px;" x-text="activity.description"></div>
                                <div style="font-size: 11px; color: #666; margin-top: 2px;" x-text="formatDate(activity.timestamp)"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="admin-card">
                    <div class="card-title">Quick Actions</div>
                    
                    <div style="display: grid; gap: 10px;">
                        <button @click="refreshAll()" class="btn btn-secondary">
                            ‚Üª Refresh All Data
                        </button>
                        <a href="/metrics.html" class="btn btn-secondary">
                            üìä View Metrics Dashboard
                        </a>
                        <a href="/sessions.html" class="btn btn-secondary">
                            üë• Monitor Sessions
                        </a>
                        <a href="/api-docs.html" class="btn btn-secondary">
                            üìö API Documentation
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Create User Modal -->
        <div x-show="showCreateUserModal" class="modal" @click.self="showCreateUserModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New User</h2>
                    <button @click="showCreateUserModal = false" class="close-btn">&times;</button>
                </div>
                <form @submit.prevent="createUser">
                    <div class="form-group">
                        <label for="newUsername">Username</label>
                        <input type="text" id="newUsername" x-model="createUserForm.username" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Password</label>
                        <input type="password" id="newPassword" x-model="createUserForm.password" required>
                    </div>
                    <div class="form-group">
                        <label>Roles</label>
                        <div class="checkbox-group">
                            <label class="checkbox">
                                <input type="checkbox" x-model="createUserForm.roles" value="user">
                                User
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" x-model="createUserForm.roles" value="admin">
                                Administrator
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" @click="showCreateUserModal = false" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div>EntityDB Admin Panel</div>
            <div>Last Updated: <span x-text="lastUpdated"></span></div>
        </footer>
    </div>

    <script>
    function adminPanel() {
        return {
            isAuthenticated: false,
            isAdmin: false,
            token: null,
            currentUser: null,
            loading: false,
            lastUpdated: null,
            
            // Data
            users: [],
            filteredUsers: [],
            health: null,
            dashboardStats: null,
            userSearch: '',
            
            // Modals
            showCreateUserModal: false,
            
            // Forms
            loginForm: { username: '', password: '' },
            createUserForm: { username: '', password: '', roles: [] },
            error: '',
            
            // Stats
            stats: {
                totalUsers: 0,
                activeUsers: 0,
                adminUsers: 0,
                activeSessions: 0
            },

            async init() {
                this.token = localStorage.getItem('authToken');
                if (this.token) {
                    await this.checkAuth();
                }
            },

            async login() {
                this.loading = true;
                this.error = '';
                
                try {
                    const response = await fetch('/api/v1/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.loginForm)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.token = data.token;
                        this.currentUser = data.user;
                        localStorage.setItem('authToken', this.token);
                        await this.checkAuth();
                    } else {
                        this.error = 'Login failed. Please check your credentials.';
                    }
                } catch (error) {
                    this.error = 'Login error: ' + error.message;
                } finally {
                    this.loading = false;
                }
            },

            async checkAuth() {
                if (!this.token) return;
                
                try {
                    // Try to fetch dashboard stats to verify admin access
                    const response = await fetch('/api/v1/dashboard/stats', {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    
                    if (response.ok) {
                        this.isAuthenticated = true;
                        this.isAdmin = true; // If can access dashboard stats, user has admin role
                        await this.fetchAllData();
                    } else {
                        this.isAuthenticated = false;
                        this.isAdmin = false;
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    this.isAuthenticated = false;
                    this.isAdmin = false;
                }
            },

            async fetchAllData() {
                await Promise.all([
                    this.fetchUsers(),
                    this.fetchHealth(),
                    this.fetchDashboardStats()
                ]);
                this.updateStats();
                this.lastUpdated = new Date().toLocaleTimeString();
            },

            async fetchUsers() {
                try {
                    const response = await fetch('/api/v1/entities/list?include_content=false', {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.users = (data.entities || []).filter(entity => 
                            entity.tags && entity.tags.some(tag => tag.includes('type:user'))
                        );
                        this.filterUsers();
                    }
                } catch (error) {
                    console.error('Error fetching users:', error);
                }
            },

            async fetchHealth() {
                try {
                    const response = await fetch('/health');
                    if (response.ok) {
                        this.health = await response.json();
                    }
                } catch (error) {
                    console.error('Error fetching health:', error);
                }
            },

            async fetchDashboardStats() {
                try {
                    const response = await fetch('/api/v1/dashboard/stats', {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    if (response.ok) {
                        this.dashboardStats = await response.json();
                    }
                } catch (error) {
                    console.error('Error fetching dashboard stats:', error);
                }
            },

            async createUser() {
                try {
                    const response = await fetch('/api/v1/users/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify(this.createUserForm)
                    });
                    
                    if (response.ok) {
                        this.showCreateUserModal = false;
                        this.createUserForm = { username: '', password: '', roles: [] };
                        await this.fetchUsers();
                    } else {
                        alert('Failed to create user');
                    }
                } catch (error) {
                    alert('Error creating user: ' + error.message);
                }
            },

            async resetPassword(user) {
                const newPassword = prompt('Enter new password for ' + this.getUserUsername(user) + ':');
                if (newPassword) {
                    // Implementation would depend on your password reset API
                    alert('Password reset functionality would be implemented here');
                }
            },

            editUser(user) {
                alert('User edit functionality would be implemented here');
            },

            async refreshAll() {
                this.loading = true;
                await this.fetchAllData();
                this.loading = false;
            },

            filterUsers() {
                let filtered = this.users;
                if (this.userSearch) {
                    filtered = filtered.filter(user => 
                        this.getUserUsername(user).toLowerCase().includes(this.userSearch.toLowerCase())
                    );
                }
                this.filteredUsers = filtered;
            },

            updateStats() {
                this.stats.totalUsers = this.users.length;
                this.stats.adminUsers = this.users.filter(user => 
                    this.getUserRoles(user).includes('admin')
                ).length;
                this.stats.activeUsers = this.users.filter(user => 
                    user.tags && user.tags.some(tag => tag.includes('status:active'))
                ).length;
                // Session count would come from session data
                this.stats.activeSessions = this.dashboardStats?.user_count || 0;
            },

            getUserUsername(user) {
                if (!user.tags) return 'Unknown';
                const usernameTag = user.tags.find(tag => tag.startsWith('username:'));
                return usernameTag ? usernameTag.replace('username:', '') : 'Unknown';
            },

            getUserRoles(user) {
                if (!user.tags) return [];
                return user.tags
                    .filter(tag => tag.startsWith('rbac:role:'))
                    .map(tag => tag.replace('rbac:role:', ''));
            },

            getHealthStyle() {
                const status = this.health?.status?.toLowerCase();
                if (status === 'healthy') return 'color: #27ae60; font-weight: bold;';
                if (status === 'warning') return 'color: #f39c12; font-weight: bold;';
                return 'color: #e74c3c; font-weight: bold;';
            },

            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            },

            formatUptime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            },

            formatDate(dateStr) {
                if (!dateStr || dateStr === '0001-01-01T00:00:00Z') return 'N/A';
                return new Date(dateStr).toLocaleString();
            }
        };
    }
    </script>
</body>
</html>