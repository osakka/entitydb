<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntityDB - Metrics Dashboard</title>
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.3/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        .health-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .health-healthy { background-color: #27ae60; }
        .health-warning { background-color: #f39c12; }
        .health-error { background-color: #e74c3c; }
        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        .nav-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }
        .nav-tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: bold;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div x-data="metricsApp" x-init="init()" class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>EntityDB Metrics Dashboard</h1>
            </div>
            <div class="header-actions">
                <a href="/" class="btn btn-secondary">← Back to Dashboard</a>
                <a href="/api-docs.html" class="btn btn-secondary">API Docs</a>
            </div>
        </header>

        <!-- Auto-refresh controls -->
        <div class="auto-refresh">
            <label class="checkbox">
                <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh()">
                Auto-refresh (30s)
            </label>
            <button @click="refreshMetrics()" class="btn btn-secondary btn-sm">
                <span class="icon">↻</span> Refresh Now
            </button>
            <span x-show="loading" class="loading-indicator">Updating...</span>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button @click="activeTab = 'overview'" :class="{'active': activeTab === 'overview'}" class="nav-tab">
                System Overview
            </button>
            <button @click="activeTab = 'performance'" :class="{'active': activeTab === 'performance'}" class="nav-tab">
                Performance
            </button>
            <button @click="activeTab = 'database'" :class="{'active': activeTab === 'database'}" class="nav-tab">
                Database
            </button>
            <button @click="activeTab = 'users'" :class="{'active': activeTab === 'users'}" class="nav-tab">
                Users & Sessions
            </button>
        </div>

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">
                    <span class="health-indicator" :class="getHealthClass()"></span>
                    System Health
                </div>
                <div class="metric-value" x-text="health?.status || 'Unknown'"></div>
                <div class="metric-label">Status</div>
                <div x-show="health?.uptime" style="margin-top: 10px;">
                    <small>Uptime: <span x-text="formatUptime(health.uptime)"></span></small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Memory Usage</div>
                <div class="metric-value" x-text="formatBytes(systemMetrics?.memory?.alloc_bytes || 0)"></div>
                <div class="metric-label">Allocated</div>
                <div style="margin-top: 10px;">
                    <small>System: <span x-text="formatBytes(systemMetrics?.memory?.sys_bytes || 0)"></span></small><br>
                    <small>Heap: <span x-text="formatBytes(systemMetrics?.memory?.heap_alloc_bytes || 0)"></span></small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Entity Count</div>
                <div class="metric-value" x-text="systemMetrics?.database?.total_entities || 0"></div>
                <div class="metric-label">Total Entities</div>
                <div style="margin-top: 10px;">
                    <template x-for="[type, count] in Object.entries(systemMetrics?.database?.entities_by_type || {})" :key="type">
                        <div><small><span x-text="type"></span>: <span x-text="count"></span></small></div>
                    </template>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Storage</div>
                <div class="metric-value" x-text="formatBytes(systemMetrics?.storage?.total_storage_bytes || 0)"></div>
                <div class="metric-label">Total Size</div>
                <div style="margin-top: 10px;">
                    <small>Database: <span x-text="formatBytes(systemMetrics?.storage?.database_size_bytes || 0)"></span></small><br>
                    <small>WAL: <span x-text="formatBytes(systemMetrics?.storage?.wal_size_bytes || 0)"></span></small>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div x-show="activeTab === 'performance'" class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Go Runtime</div>
                <div class="metric-value" x-text="systemMetrics?.system?.num_goroutines || 0"></div>
                <div class="metric-label">Goroutines</div>
                <div style="margin-top: 10px;">
                    <small>Go Version: <span x-text="systemMetrics?.system?.go_version || 'Unknown'"></span></small><br>
                    <small>CPUs: <span x-text="systemMetrics?.system?.num_cpu || 0"></span></small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Garbage Collection</div>
                <div class="metric-value" x-text="systemMetrics?.performance?.gc_runs || 0"></div>
                <div class="metric-label">GC Runs</div>
                <div style="margin-top: 10px;">
                    <small>Last Pause: <span x-text="formatNanoseconds(systemMetrics?.performance?.last_gc_pause_ns || 0)"></span></small><br>
                    <small>Total Pause: <span x-text="formatNanoseconds(systemMetrics?.performance?.total_gc_pause_ns || 0)"></span></small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Query Performance</div>
                <div class="metric-value" x-text="systemMetrics?.performance?.query_cache_hits || 0"></div>
                <div class="metric-label">Cache Hits</div>
                <div style="margin-top: 10px;">
                    <small>Cache Misses: <span x-text="systemMetrics?.performance?.query_cache_miss || 0"></span></small><br>
                    <small>Index Lookups: <span x-text="systemMetrics?.performance?.index_lookups || 0"></span></small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Memory Chart</div>
                <div class="chart-container">
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Database Tab -->
        <div x-show="activeTab === 'database'" class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Tags</div>
                <div class="metric-value" x-text="systemMetrics?.database?.tags_total || 0"></div>
                <div class="metric-label">Total Tags</div>
                <div style="margin-top: 10px;">
                    <small>Unique: <span x-text="systemMetrics?.database?.tags_unique || 0"></span></small><br>
                    <small>Avg per Entity: <span x-text="(systemMetrics?.database?.avg_tags_per_entity || 0).toFixed(1)"></span></small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Temporal Data</div>
                <div class="metric-value" x-text="systemMetrics?.temporal?.temporal_tags_count || 0"></div>
                <div class="metric-label">Temporal Tags</div>
                <div style="margin-top: 10px;">
                    <small>Ratio: <span x-text="((systemMetrics?.temporal?.temporal_tags_ratio || 0) * 100).toFixed(1)"></span>%</small><br>
                    <small>Age: <span x-text="(systemMetrics?.temporal?.average_timestamp_age_hours || 0).toFixed(1)"></span>h</small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Entity Statistics</div>
                <div class="metric-value" x-text="systemMetrics?.entity_stats?.largest_entity?.size_bytes || 0"></div>
                <div class="metric-label">Largest Entity (bytes)</div>
                <div style="margin-top: 10px;">
                    <small>Type: <span x-text="systemMetrics?.entity_stats?.largest_entity?.entity_type || 'Unknown'"></span></small><br>
                    <small>Smallest: <span x-text="systemMetrics?.entity_stats?.smallest_entity?.size_bytes || 0"></span> bytes</small>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-title">Entity Types Chart</div>
                <div class="chart-container">
                    <canvas id="entityTypesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Users & Sessions Tab -->
        <div x-show="activeTab === 'users'" class="metrics-grid">
            <div class="metric-card" x-show="dashboardStats">
                <div class="metric-title">Users</div>
                <div class="metric-value" x-text="dashboardStats?.user_count || 0"></div>
                <div class="metric-label">Total Users</div>
            </div>

            <div class="metric-card" x-show="sessionData">
                <div class="metric-title">Active Sessions</div>
                <div class="metric-value" x-text="sessionData?.length || 0"></div>
                <div class="metric-label">Current Sessions</div>
            </div>

            <div class="metric-card" x-show="dashboardStats?.recent_activity">
                <div class="metric-title">Recent Activity</div>
                <div style="max-height: 200px; overflow-y: auto;">
                    <template x-for="activity in dashboardStats.recent_activity.slice(0, 5)" :key="activity.description">
                        <div style="margin-bottom: 8px; font-size: 12px;">
                            <div x-text="activity.description"></div>
                            <small style="color: #666;" x-text="formatDate(activity.timestamp)"></small>
                        </div>
                    </template>
                </div>
                <div class="metric-label">Latest Actions</div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div>EntityDB v2.14.0+ Metrics Dashboard</div>
            <div>Last Updated: <span x-text="lastUpdated"></span></div>
        </footer>
    </div>

    <script>
    function metricsApp() {
        return {
            activeTab: 'overview',
            autoRefresh: false,
            loading: false,
            lastUpdated: new Date().toLocaleTimeString(),
            refreshInterval: null,
            
            // Data
            health: null,
            systemMetrics: null,
            dashboardStats: null,
            sessionData: null,
            
            // Charts
            memoryChart: null,
            entityTypesChart: null,

            async init() {
                await this.refreshMetrics();
                this.initCharts();
            },

            async refreshMetrics() {
                this.loading = true;
                try {
                    // Fetch all metrics
                    const [healthResp, systemResp] = await Promise.all([
                        fetch('/health'),
                        fetch('/api/v1/system/metrics')
                    ]);
                    
                    this.health = await healthResp.json();
                    this.systemMetrics = await systemResp.json();
                    
                    // Try to fetch dashboard stats if available
                    try {
                        const token = localStorage.getItem('authToken');
                        if (token) {
                            const dashboardResp = await fetch('/api/v1/dashboard/stats', {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (dashboardResp.ok) {
                                this.dashboardStats = await dashboardResp.json();
                            }
                        }
                    } catch (e) {
                        console.log('Dashboard stats not available:', e);
                    }
                    
                    this.lastUpdated = new Date().toLocaleTimeString();
                    this.updateCharts();
                } catch (error) {
                    console.error('Error fetching metrics:', error);
                } finally {
                    this.loading = false;
                }
            },

            toggleAutoRefresh() {
                if (this.autoRefresh) {
                    this.refreshInterval = setInterval(() => {
                        this.refreshMetrics();
                    }, 30000);
                } else {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                }
            },

            initCharts() {
                // Memory Chart
                const memoryCtx = document.getElementById('memoryChart');
                if (memoryCtx) {
                    this.memoryChart = new Chart(memoryCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Heap In Use', 'Heap Idle'],
                            datasets: [{
                                data: [0, 0],
                                backgroundColor: ['#3498db', '#ecf0f1']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }

                // Entity Types Chart
                const entityCtx = document.getElementById('entityTypesChart');
                if (entityCtx) {
                    this.entityTypesChart = new Chart(entityCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Count',
                                data: [],
                                backgroundColor: '#3498db'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            },

            updateCharts() {
                // Update memory chart
                if (this.memoryChart && this.systemMetrics?.memory) {
                    const memory = this.systemMetrics.memory;
                    this.memoryChart.data.datasets[0].data = [
                        memory.heap_in_use_bytes || 0,
                        memory.heap_idle_bytes || 0
                    ];
                    this.memoryChart.update();
                }

                // Update entity types chart
                if (this.entityTypesChart && this.systemMetrics?.database?.entities_by_type) {
                    const types = this.systemMetrics.database.entities_by_type;
                    this.entityTypesChart.data.labels = Object.keys(types);
                    this.entityTypesChart.data.datasets[0].data = Object.values(types);
                    this.entityTypesChart.update();
                }
            },

            getHealthClass() {
                const status = this.health?.status?.toLowerCase();
                if (status === 'healthy') return 'health-healthy';
                if (status === 'warning') return 'health-warning';
                return 'health-error';
            },

            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            },

            formatNanoseconds(ns) {
                if (ns < 1000) return ns + ' ns';
                if (ns < 1000000) return (ns / 1000).toFixed(1) + ' μs';
                return (ns / 1000000).toFixed(1) + ' ms';
            },

            formatUptime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                return `${hours}h ${minutes}m ${secs}s`;
            },

            formatDate(dateStr) {
                if (!dateStr || dateStr === '0001-01-01T00:00:00Z') return 'N/A';
                return new Date(dateStr).toLocaleString();
            }
        };
    }
    </script>
</body>
</html>